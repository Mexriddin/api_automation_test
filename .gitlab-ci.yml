stages:
  - tests
  - report

variables:
  STAGE: qa

services:
  - docker:24.0.5-dind

run-tests:
    stage: tests
    parallel:
      matrix:
        - SUITE:
            - users-api-tests
            - games-api-tests
            - wishlist-api-tests
    image: docker:24.0.5
    before_script:
      - apk add curl jq
      - ARTIFACTS_CHECK_URL="https://$CI_SERVER_HOST/api/v4/projects/$CI_PROJECT_ID/jobs/artifacts/$CI_DEFAULT_BRANCH/download?job=pages&private_token=$PRIVATE_TOKEN"
      - curl -k --location --output artifacts.zip $ARTIFACTS_CHECK_URL
      - unzip artifacts.zip
      - chmod -R 777 public
      - mkdir -p allure-results && cp -r public/history allure-results
    script:
        - docker-compose up $SUITE || true
    artifacts:
      paths:
        - allure-results
      when: on_success
      expire_in: 10 days

allure-report:
  stage: report
  needs:
    - run-tests
  image: docker:24.0.5
  script:
    - docker-compose up report
  artifacts:
    paths:
      - allure-report
    when: on_success
    expire_in: 10 days

pages:
  stage: report
  needs:
    - allure-report
  script:
    - mkdir public
    - cp -r allure-report/* public
  artifacts:
    when: on_success
    expire_in: never
    paths:
      - public
      - allure-report

notification:
  stage: report
  needs: 
    - pages
  image: docker:24.0.5
  script:
    - docker-compose up notification